;----------------------------------------------------------------------------------------------------;
;   宏定义
;   定义多行宏，%macro  宏的命名  参数个数
;   %1表示第一个参数  -->  段基址
;   %2表示第二个参数  -->  段界限
;   %3表示第三个参数  -->  段属性
;----------------------------------------------------------------------------------------------------;
%macro Descriptor 3
    dw    %2  &  0FFFFh                         ;段界限1
    dw    %1  &  0FFFFh                         ;段基址1
    db   (%1 >> 16) & 0FFh                      ;段基址2
    dw   ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)    ;属性1 + 段界限2 + 属性2
    db   (%1 >> 24) & 0FFh                      ;段基址3
%endmacro
;----------------------------------------------------------------------------------------------------;


;-----------------------------------存储段描述符类型---------------------------------------------------;
;   通过位运算确定一些存储段的描述符类型
;   例如只执行一致代码段
;----------------------------------------------------------------------------------------------------;
; 存在的、特权级为0、可读、未访问、非一致代码段类型值
DA_CODE32                 EQU		   DA_ATT1_CODE32 | DA_ATT2_CODE32

DA_ATT1_CODE32            EQU          DA_P_IN | DA_DPL_0 | DA_S_CODE | \
                                       DA_TYPE_CODE_X | DA_TYPE_CODE_C_0 | \
                                       DA_TYPE_CODE_R_0 | DA_TYPE_CODE_A_0

DA_ATT2_CODE32            EQU          DA_G_4K | DA_D_32 | DA_R_SZ | DA_AVL

; 存在的、特权级为0、可写、未访问、向上拓展数据段类型值
DA_DATA                   EQU		   DA_ATT1_DATA | DA_ATT2_DATA

DA_ATT1_DATA              EQU          DA_P_IN | DA_DPL_0 | DA_S_DATA | \
                                       DA_TYPE_DATA_X | DA_TYPE_DATA_E_HIGH | \
                                       DA_TYPE_DATA_W_1 | DA_TYPE_DATA_A_0

DA_ATT2_DATA              EQU          DA_G_4K | DA_B_32 | DA_R_SZ | DA_AVL

DA_VIDEO                  EQU		   DA_ATT1_VIDEO | DA_ATT2_VIDEO

DA_ATT1_VIDEO             EQU          DA_P_IN | DA_DPL_0 | DA_S_DATA | \
                                       DA_TYPE_DATA_X | DA_TYPE_DATA_E_HIGH | \
                                       DA_TYPE_DATA_W_1 | DA_TYPE_DATA_A_0
 
DA_ATT2_VIDEO             EQU          DA_G_4K | DA_D_32 | DA_R_SZ | DA_AVL

;----------------------------------------------------------------------------------------------------;


;--------------------------------------段属性相关常量--------------------------------------------------;
;   这里属性只占了BYTE6、BYTE5三个字节的部分数据
;   所以从BYTE5开始，记录高8~23位
;----------------------------------------------------------------------------------------------------;
DA_G_4K                   EQU          1_000_0000_0000_0000B        ; 粒度为4K
DA_G_1B                   EQU          0_000_0000_0000_0000B        ; 粒度为1Byte
DA_D_32                   EQU          01_00_0000_0000_0000B        ; 代码段32位地址
DA_B_32                   EQU          01_00_0000_0000_0000B        ; 堆栈SP32位
DA_R_SZ                   EQU          000_0_0000_0000_0000B        ; 保留位，总是置0
DA_AVL                    EQU          0000__0000_0000_0000B        ; 可用位，暂时置0

DA_P_IN                   EQU          0000_0000_1_000_0000B        ; 在内存中
DA_DPL_0                  EQU          0000_0000_0_00_0_0000B       ; 特权级为0
DA_DPL_1                  EQU          0000_0000_0_01_0_0000B       ; 特权级为1
DA_DPL_2                  EQU          0000_0000_0_10_0_0000B       ; 特权级为2
DA_DPL_3                  EQU          0000_0000_0_11_0_0000B       ; 特权级为3
DA_S_SYS                  EQU          0000_0000_0000__0000B        ; 系统段描述符
DA_S_CODE                 EQU          0000_0000_0001__0000B        ; 代码段描述符
DA_S_DATA                 EQU          0000_0000_0001__0000B        ; 数据段描述符

DA_TYPE_DATA_X            EQU          0000_0000_0000_0_000B        ; 数据段，不可执行
DA_TYPE_DATA_E_HIGH       EQU          0000_0000_0000_00_00B        ; 数据段向上拓展
DA_TYPE_DATA_E_STACK      EQU          0000_0000_0000_01_00B        ; 数据段向下拓展(堆栈段)
DA_TYPE_DATA_W_0          EQU          0000_0000_0000_000_0B        ; 数据段只读
DA_TYPE_DATA_W_1          EQU          0000_0000_0000_001_0B        ; 数据段可写
DA_TYPE_DATA_A_0          EQU          0000_0000_0000_0000_B        ; 数据段没有被访问过
DA_TYPE_DATA_A_1          EQU          0000_0000_0000_0001_B        ; 数据段被访问过

DA_TYPE_CODE_X            EQU          0000_0000_0000_1_000B        ; 代码段，可执行
DA_TYPE_CODE_C_0          EQU          0000_0000_0000_00_00B        ; 代码段，同特权级调用，非一致码段
DA_TYPE_CODE_C_1          EQU          0000_0000_0000_01_00B        ; 代码段，低特权级可转移，一致码段
DA_TYPE_CODE_R_0          EQU          0000_0000_0000_000_0B        ; 代码段不可读
DA_TYPE_CODE_R_1          EQU          0000_0000_0000_001_0B        ; 代码段可读
DA_TYPE_CODE_A_0          EQU          0000_0000_0000_0000_B        ; 代码段没有被访问过
DA_TYPE_CODE_A_1          EQU          0000_0000_0000_0001_B        ; 代码段被访问过

;----------------------------------------------------------------------------------------------------;

;--------------------------------------段选择子相关常量--------------------------------------------------;
;   这里属性只占了BYTE6、BYTE5三个字节的部分数据
;   所以从BYTE5开始，记录高8~23位
;----------------------------------------------------------------------------------------------------;
TI_GDT                    EQU          0000_0000_0000_00_00B        ; 段选择子为GDT
TI_LDT                    EQU          0000_0000_0000_01_00B        ; 段选择子为LDT
RPL_0                     EQU          0000_0000_0000_00_00B        ; RPL为0
RPL_1                     EQU          0000_0000_0000_00_01B        ; RPL为1
RPL_2                     EQU          0000_0000_0000_00_10B        ; RPL为2
RPL_3                     EQU          0000_0000_0000_00_11B        ; RPL为3

;----------------------------------------------------------------------------------------------------;